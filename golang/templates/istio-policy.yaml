{{- if .Values.istio.enabled }}
{{- if .Values.istio.policy }}
{{- $values := .Values }}
{{- $relase := .Release }}

{{ range $entry := .Values.istio.policy.jwt }}
---
apiVersion: "authentication.istio.io/v1alpha1"
kind: "Policy"
metadata:
  name: {{ $entry.name }}-jwt
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ template "golang.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: {{ .Values.appComponent }}
    app.kubernetes.io/version: {{ .Values.appVersion }}
    app.kubernetes.io/part-of: {{ .Values.appPartOf }}
    app.kubernetes.io/managed-by: helm
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
spec:
  targets:
  - name: {{ $relase.Name }}
    ports:
    - number: {{ $values.service.port }}
  origins:
  - jwt:
      issuer: {{ $entry.issuer }}
      jwksUri: {{ $entry.jwksUri }}
  principalBinding: USE_ORIGIN
  peers:
  - mtls: {}

{{- end }}

{{- end }}
{{- end }}